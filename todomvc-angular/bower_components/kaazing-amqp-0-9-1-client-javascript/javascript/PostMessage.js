/**
 * Copyright (c) 2007-2014 Kaazing Corporation. All rights reserved.
 * 
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 * 
 *   http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
function URI(a){a=a||"";var b=0,c=a.indexOf("://");if(-1!=c){this.scheme=a.slice(0,c),b=c+3;var d=a.indexOf("/",b);-1==d&&(d=a.length,a+="/");var e=a.slice(b,d);this.authority=e,b=d,this.host=e;var f=e.indexOf(":");if(-1!=f&&(this.host=e.slice(0,f),this.port=parseInt(e.slice(f+1),10),isNaN(this.port)))throw new Error("Invalid URI syntax")}var g=a.indexOf("?",b);-1!=g&&(this.path=a.slice(b,g),b=g+1);var h=a.indexOf("#",b);-1!=h?(-1!=g?this.query=a.slice(b,h):this.path=a.slice(b,h),b=h+1,this.fragment=a.slice(b)):-1!=g?this.query=a.slice(b):this.path=a.slice(b)}var browser=null;if("undefined"!=typeof ActiveXObject)browser=-1!=navigator.userAgent.indexOf("MSIE 10")?"chrome":"ie";else if(-1!=navigator.userAgent.indexOf("Trident/7")&&-1!=navigator.userAgent.indexOf("rv:11"))browser="chrome";else if("[object Opera]"==Object.prototype.toString.call(window.opera))browser="opera";else if(-1!=navigator.vendor.indexOf("Apple"))browser="safari",(-1!=navigator.userAgent.indexOf("iPad")||-1!=navigator.userAgent.indexOf("iPhone"))&&(browser.ios=!0);else if(-1!=navigator.vendor.indexOf("Google"))browser=-1!=navigator.userAgent.indexOf("Android")&&-1==navigator.userAgent.indexOf("Chrome")?"android":"chrome";else{if("Gecko"!=navigator.product||!window.find||navigator.savePreferences)throw new Error("couldn't detect browser");browser="firefox"}switch(browser){case"ie":!function(){function a(a,b,c,d){if(d)throw new Error("Not implemented");var e=a[b]||{};a[b]=e,e[c]=c}function b(a,b,c,d){if(d)throw new Error("Not implemented");var e=a[b]||{};delete e[c]}function c(a,b){var c=b.type,d=a[c]||{};for(var e in d)if(d.hasOwnProperty(e)&&"function"==typeof d[e])try{d[e](b)}catch(f){}}if(void 0===document.createEvent){var d=function(){};d.prototype.initEvent=function(a,b,c){this.type=a,this.bubbles=b,this.cancelable=c},document.createEvent=function(a){if("Events"!=a)throw new Error("Unsupported event name: "+a);return new d}}if(document._w_3_c_d_o_m_e_v_e_n_t_s_createElement=document.createElement,document.createElement=function(d){var e=this._w_3_c_d_o_m_e_v_e_n_t_s_createElement(d);if(void 0===e.addEventListener){var f={};e.addEventListener=function(b,c,d){return e.attachEvent("on"+b,c),a(f,b,c,d)},e.removeEventListener=function(a,c,d){return b(f,a,c,d)},e.dispatchEvent=function(a){return c(f,a)}}return e},void 0===window.addEventListener){var e=document.createElement("div"),f="undefined"==typeof postMessage;window.addEventListener=function(a,b,c){f&&"message"==a?e.addEventListener(a,b,c):window.attachEvent("on"+a,b)},window.removeEventListener=function(a,b,c){f&&"message"==a?e.removeEventListener(a,b,c):window.detachEvent("on"+a,b)},window.dispatchEvent=function(a){f&&"message"==a.type?e.dispatchEvent(a):window.fireEvent("on"+a.type,a)}}}();break;case"chrome":case"android":case"safari":if("undefined"==typeof window.postMessage&&"undefined"==typeof window.dispatchEvent&&"function"==typeof document.dispatchEvent){window.dispatchEvent=function(a){document.dispatchEvent(a)};var addEventListener0=window.addEventListener;window.addEventListener=function(a,b,c){"message"===a?document.addEventListener(a,b,c):addEventListener0.call(window,a,b,c)};var removeEventListener0=window.removeEventListener;window.removeEventListener=function(a,b,c){"message"===a?document.removeEventListener(a,b,c):removeEventListener0.call(window,a,b,c)}}break;case"opera":var addEventListener0=window.addEventListener;window.addEventListener=function(a,b,c){var d=b;"message"===a&&(d=function(a){if(void 0===a.origin&&void 0!==a.uri){var c=new URI(a.uri);delete c.path,delete c.query,delete c.fragment,a.origin=c.toString()}return b(a)},b._$=d),addEventListener0.call(window,a,d,c)};var removeEventListener0=window.removeEventListener;window.removeEventListener=function(a,b,c){var d=b;"message"===a&&(d=b._$),removeEventListener0.call(window,a,d,c)}}!function(){var a=URI.prototype;a.toString=function(){var a=[],b=this.scheme;if(void 0!==b){a.push(b),a.push("://"),a.push(this.host);var c=this.port;void 0!==c&&(a.push(":"),a.push(c.toString()))}return void 0!==this.path&&a.push(this.path),void 0!==this.query&&(a.push("?"),a.push(this.query)),void 0!==this.fragment&&(a.push("#"),a.push(this.fragment)),a.join("")};var b={http:80,ws:80,https:443,wss:443};URI.replaceProtocol=function(a,b){var c=a.indexOf("://");return c>0?b+a.substr(c):""}}();var postMessage0=function(){function a(a){this.sourceToken=g(Math.floor(Math.random()*(Math.pow(2,32)-1)),8),this.iframe=a,this.bridged=!1,this.lastWrite=0,this.lastRead=0,this.lastReadIndex=2,this.lastSyn=0,this.lastAck=0,this.queue=[],this.escapedFragments=[]}function b(){var a=this.reader.location.hash;this._lastHash!=a&&(i(this,a.substring(1)),this._lastHash=a)}function c(){var a=this.reader.document.URL;if(this._lastDocumentURL!=a){var b=a.indexOf("#");-1!=b&&(i(this,a.substring(b+1)),this._lastDocumentURL=a)}}function d(a,b){if(a.lastWrite<1&&!a.bridged&&b.parent==window){for(var c=a.iframe.src,d=c.split("#"),e=null,f=document.getElementsByTagName("meta"),g=0;g<f.length;g++)"kaazing:resources"==f[g].name&&alert('kaazing:resources is no longer supported. Please refer to the Administrator\'s Guide section entitled "Configuring a Web Server to Integrate with Kaazing Gateway"');var h=r,i=h.toString()+s+"?.kr=xsp&.kv=10.05";if(e){var j=new URI(h.toString()),d=e.split(":");j.host=d.shift(),d.length&&(j.port=d.shift()),i=j.toString()+s+"?.kr=xsp&.kv=10.05"}for(var g=0;g<f.length;g++)if("kaazing:postMessageBridgeURL"==f[g].name){var k=f[g].content,l=new URI(k),m=new URI(location.toString());if(!l.authority&&(l.host=m.host,l.port=m.port,l.scheme=m.scheme,0!=k.indexOf("/"))){var o=m.path.split("/");o.pop(),o.push(k),l.path=o.join("/")}n.BridgeURL=l.toString()}n.BridgeURL&&(i=n.BridgeURL);var p=["I",h,a.sourceToken,escape(i)];if(d.length>1){var q=d[1];p.push(escape(q))}d[1]=p.join("!"),setTimeout(function(){b.location.replace(d.join("#"))},200),a.bridged=!0}}function e(a,b){var c=a.writerURL+"#"+b;a.writer.location.replace(c)}function f(a){return parseInt(a,16)}function g(a,b){var c=a.toString(16),d=[];for(b-=c.length;b-->0;)d.push("0");return d.push(c),d.join("")}function h(a,b){var c=a.queue,d=a.lastRead;if((c.length>0||b)&&a.lastSyn>a.lastAck){var h=a.lastFrames,i=a.lastReadIndex;f(h[i])!=d&&(h[i]=g(d,8),e(a,h.join("")))}else if(c.length>0){var j=c.shift(),k=j[0];if("*"==k||k==a.targetOrigin){a.lastWrite++;var l=j[1],m=l.shift(),n=3,h=[a.targetToken,g(a.lastWrite,8),g(d,8),"F",g(m.length,4),m],i=2;if(l.length>0&&(h[n]="f",a.queue.unshift(j)),a.resendAck){var o=[a.targetToken,g(a.lastWrite-1,8),g(d,8),"a"];h=o.concat(h),i+=o.length}e(a,h.join("")),a.lastFrames=h,a.lastReadIndex=i,a.lastSyn=a.lastWrite,a.resendAck=!1}}else if(b){a.lastWrite++;var h=[a.targetToken,g(a.lastWrite,8),g(d,8),"a"],i=2;if(a.resendAck){var o=[a.targetToken,g(a.lastWrite-1,8),g(d,8),"a"];h=o.concat(h),i+=o.length}e(a,h.join("")),a.lastFrames=h,a.lastReadIndex=i,a.resendAck=!0}}function i(a,b){var c=b.substring(0,8),d=f(b.substring(8,16)),e=f(b.substring(16,24)),g=b.charAt(24);if(c!=a.sourceToken)throw new Error("postMessage emulation tampering detected");var k=a.lastRead,l=k+1;if(d==l&&(a.lastRead=l),(d==l||d==k)&&(a.lastAck=e),d==l||d==k&&"a"==g)switch(g){case"f":var m=b.substr(29,f(b.substring(25,29)));a.escapedFragments.push(m),h(a,!0);break;case"F":var n=b.substr(29,f(b.substring(25,29)));void 0!==a.escapedFragments&&(a.escapedFragments.push(n),n=a.escapedFragments.join(""),a.escapedFragments=[]);var o=unescape(n);j(o,a.target,a.targetOrigin),h(a,!0);break;case"a":b.length>25?i(a,b.substring(25)):h(a,!1);break;default:throw new Error("unknown postMessage emulation payload type: "+g)}}function j(a,b,c){var d=document.createEvent("Events");d.initEvent("message",!1,!0),d.data=a,d.origin=c,d.source=b,dispatchEvent(d)}function k(){for(var a=0,b=v.length;b>a;a++){var c=v[a];c.poll()}setTimeout(k,20)}function l(a){if(a==parent)return u.parent;if(a.parent!=window)throw new Error("Generic peer postMessage not yet implemented");for(var b=document.getElementsByTagName("iframe"),c=0;c<b.length;c++){var d=b[c];if(a==d.contentWindow)return m(d)}}function m(b){var c=b._name;void 0===c&&(c="iframe$"+String(Math.random()).substring(2),b._name=c);var d=u[c];return void 0===d&&(d=new a(b),u[c]=d),d}function n(a,b,c){if("string"!=typeof b)throw new Error("Unsupported type. Messages must be strings");if(a==window)("*"==c||c==r)&&j(b,window,r);else{var d=l(a);d.post(a,b,c)}}function o(){var a=new URI("ie"==browser?document.URL:location.href),b=a.fragment||"";if(null!=document.body&&b.length>0&&"I"==b.charAt(0)){var c=unescape(b),d=c.split("!");if("I"==d.shift()){var e=d.shift(),f=d.shift(),g=unescape(d.shift()),h=r;if(e==h)try{parent.location.hash}catch(i){document.domain=document.domain}var j=d.shift()||"";switch(browser){case"firefox":location.replace([location.href.split("#")[0],j].join("#"));break;default:location.hash=j}var k=l(parent);k.targetToken=f;var m=k.sourceToken,n=g+"#"+escape([h,f,m].join(",")),p;return p=document.createElement("iframe"),p.src=n,p.style.position="absolute",p.style.left="-10px",p.style.top="10px",p.style.visibility="hidden",p.style.width="0px",p.style.height="0px",void document.body.appendChild(p)}}setTimeout(o,20)}var p=new URI("ie"==browser?document.URL:location.href),q={http:80,https:443};null==p.port&&(p.port=q[p.scheme],p.authority=p.host+":"+p.port);var r=p.scheme+"://"+p.authority,s="/.kr";if("undefined"!=typeof postMessage)return function(a,b,c){if("string"!=typeof b)throw new Error("Unsupported type. Messages must be strings");switch("null"===c&&(c="*"),browser){case"ie":case"opera":case"firefox":setTimeout(function(){a.postMessage(b,c)},0);break;default:a.postMessage(b,c)}};var t=a.prototype;t.attach=function(a,d,e,f,g,i){this.target=a,this.targetOrigin=d,this.targetToken=e,this.reader=f,this.writer=g,this.writerURL=i;try{this._lastHash=f.location.hash,this.poll=b}catch(j){this._lastDocumentURL=f.document.URL,this.poll=c}a==parent&&h(this,!0)},t.detach=function(){this.poll=function(){},delete this.target,delete this.targetOrigin,delete this.reader,delete this.lastFragment,delete this.writer,delete this.writerURL},t.poll=function(){},t.post=function(a,b,c){d(this,a);for(var e=1e3,f=escape(b),g=[];f.length>e;){var i=f.substring(0,e);f=f.substring(e),g.push(i)}g.push(f),this.queue.push([c,g]),null!=this.writer&&this.lastAck>=this.lastSyn&&h(this,!1)};var u={},v=[];n.attach=function(a,b,c,d,e,f){var g=l(a);g.attach(a,b,c,d,e,f),v.push(g)};var w=function(a){var b=new URI("ie"==browser?document.URL:location.href),c,d={http:80,https:443};null==b.port&&(b.port=d[b.scheme],b.authority=b.host+":"+b.port);var e=unescape(b.fragment||"");if(e.length>0){var f=e.split(","),g=f.shift(),h=f.shift(),i=f.shift(),j=b.scheme+"://"+document.domain+":"+b.port,k=b.scheme+"://"+b.authority,l=g+"/.kr?.kr=xsc&.kv=10.05",m=document.location.toString().split("#")[0],n=l+"#"+escape([j,h,escape(m)].join(","));if("undefined"!=typeof ActiveXObject){c=new ActiveXObject("htmlfile"),c.open();try{c.parentWindow.opener=window}catch(o){a&&(c.domain=a),c.parentWindow.opener=window}c.write("<html>"),c.write("<body>"),a&&c.write("<script>CollectGarbage();document.domain='"+a+"';</script>"),c.write('<iframe src="'+l+'"></iframe>'),c.write("</body>"),c.write("</html>"),c.close();var p=c.body.lastChild,q=c.parentWindow,r=parent,s=r.parent.postMessage0;"undefined"!=typeof s&&(p.onload=function(){var a=p.contentWindow;a.location.replace(n),s.attach(r,g,i,q,a,l)})}else{var p=document.createElement("iframe");p.src=n,document.body.appendChild(p);var q=window,t=p.contentWindow,r=parent,s=r.parent.postMessage0;"undefined"!=typeof s&&s.attach(r,g,i,q,t,l)}}window.onunload=function(){try{var a=window.parent.parent.postMessage0;"undefined"!=typeof a&&a.detach(r)}catch(b){}"undefined"!=typeof c&&(c.parentWindow.opener=null,c.open(),c.close(),c=null,CollectGarbage())}};n.__init__=function(a,b){var c=w.toString();a.URI=URI,a.browser=browser,b||(b=""),a.setTimeout("("+c+")('"+b+"')",0)},n.bridgeURL=!1,n.detach=function(a){for(var b=l(a),c=0;c<v.length;c++)v[c]==b&&v.splice(c,1);b.detach()},window!=top&&(u.parent=new a,o());for(var x=document.getElementsByTagName("meta"),y=0;y<x.length;y++)if("kaazing:postMessage"===x[y].name){if("immediate"==x[y].content){var z=function(){for(var a=document.getElementsByTagName("iframe"),b=0;b<a.length;b++){var c=a[b];if("immediate"==c.style.KaaPostMessage){c.style.KaaPostMessage="none";var e=m(c);d(e,c.contentWindow)}}setTimeout(z,20)};setTimeout(z,20)}break}for(var y=0;y<x.length;y++)if("kaazing:postMessagePrefix"===x[y].name){var A=x[y].content;null!=A&&A.length>0&&("/"!=A.charAt(0)&&(A="/"+A),s=A)}return setTimeout(k,20),n}();